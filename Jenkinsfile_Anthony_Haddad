pipeline {
  agent any

  stages {

    stage('Setup') {
      steps {
        script {
          if (isUnix()) {
            sh '''
              set -e
              if [ ! -d venv ]; then python3 -m venv venv; fi
              . venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            '''
          } else {
            bat '''
              if not exist venv (python -m venv venv)
              call venv\\Scripts\\activate
              pip install --upgrade pip
              pip install -r requirements.txt
            '''
          }
        }
      }
    }

    stage('Lint') {
      steps {
        script {
          if (isUnix()) {
            sh '. venv/bin/activate && flake8 app.py'
          } else {
            bat 'call venv\\Scripts\\activate && flake8 app.py'
          }
        }
      }
    }

    stage('Test') {
      steps {
        script {
          if (isUnix()) {
            sh '''
              mkdir -p reports
              . venv/bin/activate && pytest -q --junitxml=reports/junit.xml
            '''
          } else {
            bat '''
              if not exist reports mkdir reports
              call venv\\Scripts\\activate && pytest -q --junitxml=reports\\junit.xml
            '''
          }
        }
      }
      post {
        always {
          junit 'reports/junit.xml'
        }
      }
    }

    stage('Coverage') {
      steps {
        script {
          if (isUnix()) {
            sh '''
              mkdir -p reports
              . venv/bin/activate && coverage erase
              . venv/bin/activate && coverage run -m pytest -q
              . venv/bin/activate && coverage xml -o reports/coverage.xml
              . venv/bin/activate && coverage html -d htmlcov
            '''
          } else {
            bat '''
              if not exist reports mkdir reports
              call venv\\Scripts\\activate && coverage erase
              call venv\\Scripts\\activate && coverage run -m pytest -q
              call venv\\Scripts\\activate && coverage xml -o reports\\coverage.xml
              call venv\\Scripts\\activate && coverage html -d htmlcov
            '''
          }
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'reports/coverage.xml, htmlcov/**', fingerprint: true
        }
      }
    }

    stage('Security Scan') {
      steps {
        script {
          if (isUnix()) {
            sh '. venv/bin/activate && bandit -r . -lll -q'
          } else {
            bat 'call venv\\Scripts\\activate && bandit -r . -lll -q'
          }
        }
      }
      post {
        unsuccessful {
          echo 'Bandit found HIGH severity issues.'
        }
      }
    }

    stage('Deploy') {
      steps {
        script {
          if (isUnix()) {
            sh '''
              rm -rf build release || true
              mkdir -p build release
              cp app.py build/
              . venv/bin/activate && python3 -m zipfile -c release/app.zip build/app.py
              rm -rf /tmp/lab_deploy || true
              mkdir -p /tmp/lab_deploy
              cp release/app.zip /tmp/lab_deploy/
            '''
          } else {
            bat '''
              rmdir /S /Q build 2>nul
              rmdir /S /Q release 2>nul
              mkdir build
              mkdir release
              copy /Y app.py build\\
              call venv\\Scripts\\activate && python -m zipfile -c release\\app.zip build\\app.py
              rmdir /S /Q C:\\lab_deploy 2>nul
              mkdir C:\\lab_deploy
              copy /Y release\\app.zip C:\\lab_deploy\\
            '''
          }
        }
      }
      post {
        success {
          archiveArtifacts artifacts: 'release/app.zip', fingerprint: true
          echo 'Deployment completed (simulated).'
        }
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
